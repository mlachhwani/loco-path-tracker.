<!DOCTYPE html>
<html>
<head>
    <title>Sanket 3.0 - Full Audit Suite</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --rail-blue: #002f6c; --rail-active: #1a73e8; --violation: #d93025; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; scroll-behavior: smooth; font-family: 'Segoe UI', sans-serif; }
        
        /* Full Page Sections */
        section { height: 100vh; width: 100%; position: relative; border-bottom: 2px solid #ccc; display: flex; flex-direction: column; }
        .content { padding: 40px; flex: 1; }

        /* SECTION 1: INPUT FORM */
        #input-page { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); align-items: center; justify-content: center; }
        .form-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 800px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-card h2 { grid-column: span 2; color: var(--rail-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: bold; color: #555; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .btn-audit { grid-column: span 2; background: var(--rail-blue); color: white; padding: 15px; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-audit:hover { background: var(--rail-active); }

        /* SECTION 2: MAP */
        #map { height: 100%; width: 100%; }
        .map-overlay { position: absolute; top: 20px; left: 60px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* SECTION 3 & 4: GRAPHS */
        .chart-box { flex: 1; padding: 20px; background: white; position: relative; }
        
        .blink-path { animation: blinker 0.8s linear infinite; stroke: red; stroke-width: 8; }
        @keyframes blinker { 50% { opacity: 0.1; } }
        .nav-dots { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); z-index: 3000; }
        .dot { width: 12px; height: 12px; background: rgba(0,0,0,0.3); border-radius: 50%; margin: 10px; cursor: pointer; display: block; }
        .dot.active { background: var(--rail-active); }
    </style>
</head>
<body>

<div class="nav-dots">
    <a href="#input-page" class="dot active"></a>
    <a href="#map-page" class="dot"></a>
    <a href="#journey-page" class="dot"></a>
    <a href="#braking-page" class="dot"></a>
</div>

<section id="input-page">
    <div class="form-card">
        <h2>Crew Performance Audit Input</h2>
        <div class="input-group">
            <label>CLI ID</label>
            <input type="text" id="cliId" placeholder="Enter CLI ID" oninput="lookup('cli')">
            <div id="cliDisp" style="font-size:11px; color:var(--rail-active)">-</div>
        </div>
        <div class="input-group">
            <label>Loco Number</label>
            <input type="text" id="locoNo" placeholder="e.g. 30385">
        </div>
        <div class="input-group">
            <label>LP ID</label>
            <input type="text" id="lpId" oninput="lookup('lp')">
            <div id="lpDisp" style="font-size:11px; color:var(--rail-active)">-</div>
        </div>
        <div class="input-group">
            <label>ALP ID</label>
            <input type="text" id="alpId" oninput="lookup('alp')">
            <div id="alpDisp" style="font-size:11px; color:var(--rail-active)">-</div>
        </div>
        <div class="input-group">
            <label>Stock Type</label>
            <select id="stockType">
                <option value="COACHING">Coaching</option>
                <option value="VB">Vande Bharat</option>
                <option value="GOODS">Goods</option>
                <option value="LE">Light Engine</option>
            </select>
        </div>
        <div class="input-group">
            <label>MPS Limit</label>
            <select id="mpsLimit"></select>
        </div>
        <div class="input-group" style="grid-column: span 2;">
            <label>Loco GPS File (.csv)</label>
            <input type="file" id="locoFile">
        </div>
        <button class="btn-audit" onclick="startProcess()">PROCESS AUDIT DATA</button>
    </div>
</section>

<section id="map-page">
    <div class="map-overlay">
        <div id="m-speed" style="font-size:32px; font-weight:bold; color:red;">0 KMPH</div>
        <div id="m-stn" style="font-weight:bold;">Wait for Data...</div>
    </div>
    <div id="map"></div>
</section>

<section id="journey-page">
    <div class="content">
        <h2 style="color:var(--rail-blue)">Full Journey Speed Profile</h2>
        <div class="chart-box"><canvas id="journeyChart"></canvas></div>
    </div>
</section>

<section id="braking-page">
    <div class="content">
        <h2 style="color:var(--rail-blue)">Braking Technique & Violation Audit</h2>
        <div class="chart-box"><canvas id="brakingChart"></canvas></div>
    </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.23, 79.28], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let masters = { cli:[], crew:[], stn:[] };
    let locoData = [];

    // Init Logic
    window.onload = () => {
        const mps = document.getElementById('mpsLimit');
        for(let i=40; i<=140; i+=5) mps.add(new Option(i + " KMPH", i));
        mps.value = 110;

        Papa.parse("master/cli_master.csv", { download: true, header: true, complete: r => masters.cli = r.data });
        Papa.parse("master/crew_master.csv", { download: true, header: true, complete: r => masters.crew = r.data });
        Papa.parse("master/station.csv", { download: true, header: true, complete: r => {
            masters.stn = r.data;
            r.data.forEach(s => {
                // Stations aur Signals mapping firse add ki gayi
                L.rectangle([[s.Start_Lat, s.Start_Lng], [s.End_Lat, s.End_Lng]], {color:'orange'}).addTo(map).bindTooltip(s.Station_Name);
            });
        }});
    };

    function lookup(type) {
        const id = document.getElementById(type+'Id').value.toUpperCase();
        if(type === 'cli') {
            const f = masters.cli.find(x => x.CLI_ID === id);
            document.getElementById('cliDisp').innerText = f ? f.CLI_NAME : "Not Found";
        } else {
            const f = masters.crew.find(x => x.CREW_ID === id);
            document.getElementById(type+'Disp').innerText = f ? f.CREW_NAME + " (" + f.DESIGNATION + ")" : "Not Found";
        }
    }

    function startProcess() {
        const file = document.getElementById('locoFile').files[0];
        if(!file) return alert("File chuniye");
        
        Papa.parse(file, {
            header: true, dynamicTyping: true, complete: r => {
                locoData = r.data.filter(d => d.Latitude).map(d => ({
                    lat: d.Latitude, lng: d.Longitude, speed: d.Speed, stn: d['last/cur stationCode']
                }));
                alert("Data Processed! Neeche scroll karein.");
                renderAll();
            }
        });
    }

    function renderAll() {
        // Map Rendering with Blinking Violations
        const path = locoData.map(p => [p.lat, p.lng]);
        L.polyline(path, {color: '#1a73e8', weight: 3}).addTo(map);
        map.fitBounds(path);

        // Journey Graph logic aur Braking Graph logic yahan aayenge
        // Violation red illumination ke sath
    }
</script>
</body>
</html>
