<!DOCTYPE html>
<html>
<head>
    <title>Loco Path Master - Mukesh Favorite</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; background: #f0f0f0; }
        .control-panel { position: absolute; background: white; padding: 10px; z-index: 1000; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .top-left { top: 10px; left: 50px; display: flex; gap: 10px; }
        .info-panel { top: 10px; right: 10px; width: 200px; }
        .bottom-left { bottom: 20px; left: 20px; border: 2px dashed #007bff; }
        .label { font-size: 10px; color: #666; font-weight: bold; }
        .value { font-size: 14px; margin-bottom: 5px; color: #d32f2f; font-weight: bold; }
        #speed-val { font-size: 24px; }
        select { padding: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="control-panel top-left">
    <select id="crew1"><option>Mukesh (LP)</option><option>Suresh (LP)</option></select>
    <select id="crew2"><option>Amit (ALP)</option><option>Rajesh (ALP)</option></select>
</div>

<div class="control-panel info-panel">
    <div class="label">SPEED (KM/H)</div>
    <div id="speed-val" class="value">0.0</div>
    <div class="label">TIME</div>
    <div id="time-val" class="value">-</div>
    <div class="label">STATION/SIGNAL</div>
    <div id="loc-val" class="value">-</div>
</div>

<div class="control-panel bottom-left">
    <div style="font-size:12px; font-weight:bold;">UPLOAD LOCO CSV</div>
    <input type="file" id="locoUpload" accept=".csv">
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.23, 79.28], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let mapData = [];
    let pathLayer, pointer;

    // --- COORDINATE CONVERTER (DDMM.MMMM to DD.DDDD) ---
    function convertCoord(val) {
        if (!val) return 0;
        let str = val.toString();
        let dotIdx = str.indexOf('.');
        let degrees = parseFloat(str.substring(0, dotIdx - 2));
        let minutes = parseFloat(str.substring(dotIdx - 2));
        return degrees + (minutes / 60);
    }

    // --- DATASETS (Directly Embedded from your files) ---
    const stations = [
        {name: "SAL", sLat: 2114.18260, sLng: 7916.97050, eLat: 2114.14920, eLng: 7918.06190},
        {name: "DURG", sLat: 2111.16490, sLng: 8116.84900, eLat: 2111.77460, eLng: 8118.19530}
        // Add more from your station.csv here
    ];

    // --- DRAW STATION YARDS ---
    stations.forEach(st => {
        let bounds = [
            [convertCoord(st.sLat), convertCoord(st.sLng)],
            [convertCoord(st.eLat), convertCoord(st.eLng)]
        ];
        L.rectangle(bounds, {color: "orange", weight: 1, fillOpacity: 0.2}).addTo(map)
         .bindTooltip(st.name, {permanent: true, direction: "center"});
    });

    // --- OFFSET LOGIC FOR UP/MID/DN ---
    function getOffset(line) {
        if (line.includes("DN")) return 0.00015;  // North shift
        if (line.includes("UP")) return -0.00015; // South shift
        return 0; // MID stay at center
    }

    // --- POINTER LOGIC ---
    pointer = L.circleMarker([0,0], {radius: 7, color: 'red', fillColor: '#f03', fillOpacity: 1}).addTo(map);

    map.on('mousemove', function(e) {
        if (mapData.length === 0) return;
        let closest = mapData[0];
        let minD = Infinity;
        
        mapData.forEach(p => {
            let d = map.distance(e.latlng, [p.lat, p.lng]);
            if (d < minD) { minD = d; closest = p; }
        });

        pointer.setLatLng([closest.lat, closest.lng]);
        document.getElementById('speed-val').innerText = closest.s;
        document.getElementById('time-val').innerText = closest.t;
        document.getElementById('loc-val').innerText = closest.st;
    });

    // --- LOCO FILE UPLOAD ---
    document.getElementById('locoUpload').addEventListener('change', function(e) {
        Papa.parse(e.target.files[0], {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                mapData = results.data.filter(r => r.Latitude).map(r => ({
                    t: r['Logging Time'],
                    lat: r.Latitude, // GPS data is usually already in Decimal
                    lng: r.Longitude,
                    s: r.Speed,
                    st: r['last/cur stationCode']
                }));
                if (pathLayer) map.removeLayer(pathLayer);
                pathLayer = L.polyline(mapData.map(p => [p.lat, p.lng]), {color: 'blue', weight: 4}).addTo(map);
                map.fitBounds(pathLayer.getBounds());
            }
        });
    });
</script>
</body>
</html>
