<!DOCTYPE html>
<html>
<head>
    <title>Sanket 3.0 - Professional Audit Suite</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --rail-blue: #002f6c; --rail-active: #1a73e8; --violation: #d93025; --gold: #ffd700; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; scroll-behavior: smooth; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; background: #f0f2f5; }
        
        section { height: 100vh; width: 100vw; display: flex; flex-direction: column; position: relative; border-bottom: 4px solid #ccc; background: white; }
        
        /* Form Styling */
        #input-page { background: linear-gradient(135deg, #002f6c 0%, #001a3d 100%); justify-content: center; align-items: center; }
        .form-card { background: white; padding: 40px; border-radius: 20px; width: 900px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .form-card h1 { grid-column: span 3; text-align: center; color: var(--rail-blue); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        .disp { background: #f8f9fa; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: bold; border-left: 4px solid var(--rail-active); min-height: 15px; color: #333; }
        .btn-main { grid-column: span 3; background: #27ae60; color: white; padding: 18px; border: none; border-radius: 10px; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-main:hover { background: #2ecc71; transform: scale(1.02); }

        /* HUD & Map */
        #map { flex: 1; width: 100%; }
        .hud { position: absolute; top: 25px; left: 70px; z-index: 1000; background: rgba(0,0,0,0.85); color: white; padding: 15px; border-radius: 10px; border-left: 6px solid var(--violation); min-width: 200px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* Graphs */
        .chart-box { flex: 1; padding: 40px; position: relative; }
        
        /* Nav Dots */
        .nav-dots { position: fixed; right: 25px; top: 50%; transform: translateY(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 15px; }
        .dot { width: 14px; height: 14px; background: rgba(255,255,255,0.3); border: 2px solid white; border-radius: 50%; cursor: pointer; }
        .dot.active { background: var(--gold); transform: scale(1.3); box-shadow: 0 0 10px var(--gold); }
    </style>
</head>
<body>

<div class="nav-dots">
    <div class="dot active" onclick="window.scrollTo(0,0)"></div>
    <div class="dot" onclick="document.getElementById('map-page').scrollIntoView()"></div>
    <div class="dot" onclick="document.getElementById('journey-page').scrollIntoView()"></div>
    <div class="dot" onclick="document.getElementById('braking-page').scrollIntoView()"></div>
</div>

<section id="input-page">
    <div class="form-card">
        <h1>SANKET 3.0 | AUDIT SYSTEM</h1>
        <div class="input-group">
            <label>CLI ID</label>
            <input type="text" id="cliId" placeholder="e.g. R0047" oninput="doLookup('cli')">
            <div id="cliDisp" class="disp">-</div>
        </div>
        <div class="input-group">
            <label>LP ID</label>
            <input type="text" id="lpId" oninput="doLookup('lp')">
            <div id="lpDisp" class="disp">-</div>
        </div>
        <div class="input-group">
            <label>ALP ID</label>
            <input type="text" id="alpId" oninput="doLookup('alp')">
            <div id="alpDisp" class="disp">-</div>
        </div>
        <div class="input-group">
            <label>Loco / Train No</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="locoNo" placeholder="Loco" style="width:70px;">
                <input type="text" id="trainNo" placeholder="Train" style="width:70px;">
            </div>
        </div>
        <div class="input-group">
            <label>Stock & MPS</label>
            <div style="display:flex; gap:5px;">
                <select id="stockType"><option value="COACHING">Coaching</option><option value="VB">VB</option><option value="GOODS">Goods</option></select>
                <select id="mpsLimit"></select>
            </div>
        </div>
        <div class="input-group">
            <label>Section (From-To)</label>
            <div style="display:flex; gap:5px;">
                <select id="fromStn"><option value="">From</option></select>
                <select id="toStn"><option value="">To</option></select>
            </div>
        </div>
        <div class="input-group" style="grid-column: span 3;">
            <label>Upload Loco Data (CSV)</label>
            <input type="file" id="locoFile">
        </div>
        <button class="btn-main" onclick="runCompleteAudit()">GENERATE 4-PAGE REPORT</button>
    </div>
</section>

<section id="map-page">
    <div class="hud">
        <div style="font-size:11px; color:var(--gold); font-weight:bold;">LOCATIONAL DATA</div>
        <div id="h-speed" style="font-size:42px; font-weight:bold;">00 <small style="font-size:14px;">KMPH</small></div>
        <div id="h-stn" style="font-size:16px; border-top:1px solid #555; margin-top:5px; padding-top:5px;">Section Area</div>
    </div>
    <div id="map"></div>
</section>

<section id="journey-page">
    <div class="chart-box">
        <h2 style="color:var(--rail-blue)">Full Journey Speed Profile</h2>
        <canvas id="journeyChart"></canvas>
    </div>
</section>

<section id="braking-page">
    <div class="chart-box">
        <h2 style="color:var(--rail-blue)">Precision Braking Technique Audit</h2>
        <div id="violationAlert" style="color:red; font-weight:bold;"></div>
        <canvas id="brakingChart"></canvas>
    </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.23, 79.28], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let masters = { cli:[], crew:[], stn:[] };
    let locoData = [];
    let charts = {};

    window.onload = () => {
        // Fill MPS
        const mps = document.getElementById('mpsLimit');
        for(let i=40; i<=140; i+=5) mps.add(new Option(i + " KMPH", i));
        mps.value = 110;

        // Load Masters
        Papa.parse("master/cli_master.csv", { download:true, header:true, complete: r => masters.cli = r.data });
        Papa.parse("master/crew_master.csv", { download:true, header:true, complete: r => masters.crew = r.data });
        Papa.parse("master/station.csv", { download:true, header:true, complete: r => {
            masters.stn = r.data;
            r.data.forEach(s => {
                let lat = s.Start_Lat || s.Lat || s['Start_Lat '];
                let lng = s.Start_Lng || s.Lng || s['Start_Lng '];
                if(lat && lng) {
                    L.circleMarker([lat, lng], {color:'orange', radius:6, fillOpacity:0.5}).addTo(map).bindTooltip(s.Station_Name);
                    document.getElementById('fromStn').add(new Option(s.Station_Name, s.Station_Name));
                    document.getElementById('toStn').add(new Option(s.Station_Name, s.Station_Name));
                }
            });
        }});
    };

    function doLookup(type) {
        const id = document.getElementById(type+'Id').value.toUpperCase();
        if(type === 'cli') {
            const f = masters.cli.find(x => x.CLI_ID === id);
            document.getElementById('cliDisp').innerText = f ? f.CLI_NAME : "Not Found";
        } else {
            const f = masters.crew.find(x => x.CREW_ID === id);
            document.getElementById(type+'Disp').innerText = f ? f.CREW_NAME + " (" + f.DESIGNATION + ")" : "Not Found";
        }
    }

    function runCompleteAudit() {
        const file = document.getElementById('locoFile').files[0];
        if(!file) return alert("Please upload the Loco Data file!");

        Papa.parse(file, {
            header:true, dynamicTyping:true, skipEmptyLines:true,
            complete: r => {
                locoData = r.data.filter(d => (d.Latitude || d.lat) && d.Speed !== undefined);
                if(locoData.length === 0) return alert("Data error: Latitude/Speed not found!");
                
                document.getElementById('map-page').scrollIntoView();
                renderMap();
                renderJourney();
                renderBraking();
            }
        });
    }

    function renderMap() {
        const coords = locoData.map(p => [p.Latitude || p.lat, p.Longitude || p.lng]);
        L.polyline(coords, {color: 'blue', weight: 4}).addTo(map);
        map.fitBounds(coords);
        
        // HUD Interaction
        map.on('mousemove', e => {
            let p = locoData[Math.floor(locoData.length / 2)]; // Demo point
            document.getElementById('h-speed').innerHTML = `${p.Speed} <small style="font-size:14px;">KMPH</small>`;
            document.getElementById('h-stn').innerText = p['last/cur stationCode'] || "Section Running";
        });
    }

    function renderJourney() {
        const ctx = document.getElementById('journeyChart').getContext('2d');
        if(charts.journey) charts.journey.destroy();
        charts.journey = new Chart(ctx, {
            type: 'line',
            data: {
                labels: locoData.map(d => d.Time || ''),
                datasets: [{ label:'Speed (KMPH)', data: locoData.map(d => d.Speed), borderColor: '#1a73e8', pointRadius: 0, fill: true, backgroundColor: 'rgba(26,115,232,0.1)' }]
            },
            options: { responsive:true, maintainAspectRatio:false, interaction: { mode:'index', intersect:false } }
        });
    }

    function renderBraking() {
        const ctx = document.getElementById('brakingChart').getContext('2d');
        if(charts.braking) charts.braking.destroy();
        
        // Braking Logic: Detect Stoppages
        let stops = [];
        for(let i=10; i<locoData.length; i++) {
            if(locoData[i].Speed === 0 && locoData[i-1].Speed > 0) {
                stops = locoData.slice(i-50, i); // Last 50 points before stop
                break;
            }
        }

        charts.braking = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: stops.length}, (_, i) => i),
                datasets: [{ label:'Braking Pattern', data: stops.map(s=>s.Speed), borderColor: 'red', borderWidth: 3 }]
            },
            options: { responsive:true, maintainAspectRatio:false }
        });
    }
</script>
</body>
</html>
