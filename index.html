<!DOCTYPE html>
<html>
<head>
    <title>Sanket 3.2 - Stable Fix</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
        header { background: #002f6c; color: white; padding: 15px 25px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 11px; font-weight: bold; color: #adcce9; margin-bottom: 3px; }
        input, select { padding: 8px; border-radius: 5px; border: none; font-size: 13px; }
        .name-box { font-size: 12px; font-weight: bold; margin-top: 5px; color: #fff; height: 15px; }
        .btn-go { background: #28a745; color: white; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; grid-column: span 1; height: 40px; align-self: end; }
        
        main { display: grid; grid-template-rows: 1.5fr 1fr; gap: 10px; padding: 15px; flex: 1; overflow: hidden; }
        #map { background: #ddd; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .graph-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .chart-card { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    </style>
</head>
<body>

<header>
    <div class="input-group">
        <label>CLI ID</label>
        <input type="text" id="cliId" placeholder="e.g. R0047" oninput="doLookup('cli')">
        <div id="cliN" class="name-box">-</div>
    </div>
    <div class="input-group">
        <label>LP ID</label>
        <input type="text" id="lpId" oninput="doLookup('lp')">
        <div id="lpN" class="name-box">-</div>
    </div>
    <div class="input-group">
        <label>Section From/To</label>
        <div style="display:flex; gap:5px;">
            <select id="fStn" style="width:50%"><option>From</option></select>
            <select id="tStn" style="width:50%"><option>To</option></select>
        </div>
    </div>
    <div class="input-group">
        <label>RTIS Loco File (CSV)</label>
        <input type="file" id="locoF">
    </div>
    <button class="btn-go" onclick="runAudit()">GENERATE REPORT</button>
</header>

<main>
    <div id="map"></div>
    <div class="graph-area">
        <div class="chart-card">
            <h4 style="margin:0">Speed Profile (Full Section)</h4>
            <canvas id="jChart"></canvas>
        </div>
        <div class="chart-card">
            <h4 style="margin:0">Braking Audit (Violation Check)</h4>
            <canvas id="bChart"></canvas>
        </div>
    </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.23, 79.28], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let masters = { cli:[], crew:[], stn:[] };
    let charts = {};

    window.onload = () => {
        // Load All Master Data
        Papa.parse("master/cli_master.csv", { download: true, header: true, complete: r => masters.cli = r.data });
        Papa.parse("master/crew_master.csv", { download: true, header: true, complete: r => masters.crew = r.data });
        Papa.parse("master/station.csv", { download: true, header: true, complete: r => {
            masters.stn = r.data;
            r.data.forEach(s => {
                const name = s.Station_Name || s.STATION;
                document.getElementById('fStn').add(new Option(name, name));
                document.getElementById('tStn').add(new Option(name, name));
                let lat = s.Start_Lat || s.Lat || s.LAT;
                let lng = s.Start_Lng || s.Lng || s.LNG;
                if(lat) L.circleMarker([lat, lng], {radius: 5, color: 'orange'}).addTo(map).bindTooltip(name);
            });
        }});
    };

    function doLookup(type) {
        const id = document.getElementById(type+'Id').value.toUpperCase();
        const found = (type==='cli' ? masters.cli : masters.crew).find(x => (x.CLI_ID || x.CREW_ID) === id);
        document.getElementById(type+(type==='cli'?'N':'N')).innerText = found ? (found.CLI_NAME || found.CREW_NAME) : "-";
    }

    function runAudit() {
        const file = document.getElementById('locoF').files[0];
        if(!file) return alert("Select File First!");

        Papa.parse(file, {
            header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: r => {
                const data = r.data.filter(d => (d.Latitude || d.lat) && d.Speed != null);
                if(data.length === 0) return alert("Error: CSV mein Latitude/Speed nahi hai!");
                
                // Draw Path
                const pts = data.map(p => [p.Latitude || p.lat, p.Longitude || p.lng]);
                L.polyline(pts, {color: 'blue', weight: 3}).addTo(map);
                map.fitBounds(pts);

                // Speed Graph
                if(charts.j) charts.j.destroy();
                charts.j = new Chart(document.getElementById('jChart'), {
                    type: 'line',
                    data: { labels: data.map((_,i)=>i), datasets: [{ label:'KMPH', data: data.map(d=>d.Speed), borderColor: 'blue', pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Braking Graph (Last 200 points only)
                if(charts.b) charts.b.destroy();
                const bData = data.slice(-200);
                charts.b = new Chart(document.getElementById('bChart'), {
                    type: 'line',
                    data: { labels: bData.map((_,i)=>i), datasets: [{ label:'Braking', data: bData.map(d=>d.Speed), borderColor: 'red' }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        });
    }
</script>
</body>
</html>
