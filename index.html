<!DOCTYPE html>
<html>
<head>
    <title>SECR Master Audit - M. Lachhwani</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial; background: #f4f7f9; }
        .header { background: #002f6c; color: white; padding: 15px; text-align: center; font-size: 22px; font-weight: bold; border-bottom: 4px solid #d93025; }
        #control-panel { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #map { height: 750px; width: 98%; margin: 10px auto; border-radius: 8px; display: none; border: 2px solid #002f6c; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-group { flex: 1; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-weight: bold; }
        .btn-run { width: 100%; padding: 15px; background: #28a745; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 6px; }
        .btn-run:hover { background: #218838; }
    </style>
</head>
<body>

<div class="header">SOUTH EAST CENTRAL RAILWAY - SAFETY AUDIT</div>

<div id="control-panel">
    <div class="row">
        <div class="input-group"><label>Train No:</label><input type="text" id="t_no"></div>
        <div class="input-group"><label>Date:</label><input type="date" id="j_date"></div>
    </div>
    <div class="row">
        <div class="input-group"><label>From Station:</label><select id="s_from"></select></div>
        <div class="input-group"><label>To Station:</label><select id="s_to"></select></div>
    </div>
    <div class="row">
        <div class="input-group">
            <label>Crew ID (Master List Search):</label>
            <input type="text" id="crew_id" placeholder="Enter Crew ID" oninput="searchCrew()">
            <div id="crew_display" style="margin-top:5px; color:#d93025; font-weight:bold;">Name: -</div>
        </div>
    </div>
    <div class="row">
        <div class="input-group"><label>Upload RTIS CSV File:</label><input type="file" id="rtis_file" accept=".csv"></div>
    </div>
    <button class="btn-run" onclick="initMap()">GENERATE AUDIT MAP</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let masterData = { stations: [], crew: [], signals: [] };
    document.getElementById('j_date').valueAsDate = new Date();

    // 1. Data Loading on Startup
    window.onload = function() {
        const nocache = "?t=" + Date.now();
        
        // Stations
        Papa.parse("master/station.csv" + nocache, { download: true, header: true, complete: r => {
            masterData.stations = r.data;
            let list = r.data.map(s => `<option value="${s.Station_Name}">${s.Station_Name}</option>`).join('');
            document.getElementById('s_from').innerHTML = list;
            document.getElementById('s_to').innerHTML = list;
        }});

        // Crew Master Search [cite: 2026-01-08]
        Papa.parse("master/crew_master.csv" + nocache, { download: true, header: true, complete: r => { masterData.crew = r.data; } });

        // Load 4 Signal Files with Specific Colors
        const sigConfigs = [
            { file: 'master/up_signals.csv', clr: 'green', type: 'UP' },
            { file: 'master/dn_signals.csv', clr: 'blue', type: 'DN' },
            { file: 'master/up_mid_signals.csv', clr: 'purple', type: 'UP-M' },
            { file: 'master/dn_mid_signals.csv', clr: 'red', type: 'DN-M' }
        ];

        sigConfigs.forEach(conf => {
            Papa.parse(conf.file + nocache, { download: true, header: true, complete: r => {
                r.data.forEach(s => { s.color = conf.clr; s.typeName = conf.type; masterData.signals.push(s); });
            }});
        });
    };

    function searchCrew() {
        let id = document.getElementById('crew_id').value.toUpperCase();
        let found = masterData.crew.find(c => (c.CREW_ID || c.ID || "").toString().toUpperCase() === id);
        document.getElementById('crew_display').innerText = "Name: " + (found ? (found.CREW_NAME || found.NAME) : "-");
    }

    function initMap() {
        const file = document.getElementById('rtis_file').files[0];
        if(!file) return alert("RTIS File Select Karein!");

        document.getElementById('control-panel').style.display = 'none';
        document.getElementById('map').style.display = 'block';

        const map = L.map('map').setView([21.14, 79.08], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Plot Stations (Rectangle/Banner Logic)
        masterData.stations.forEach(s => {
            let lat = parseFloat(s.Start_Lat), lng = parseFloat(s.Start_Lng);
            if(!isNaN(lat)) {
                L.marker([lat, lng], {
                    icon: L.divIcon({ className: 'stn-label', html: `<b style="background:orange; padding:2px; border:1px solid black;">${s.Station_Name}</b>`, iconSize: [50, 20] })
                }).addTo(map);
            }
        });

        // Plot Signals (Decided Colors)
        masterData.signals.forEach(sig => {
            let lat = parseFloat(sig.LAT || sig.Latitude), lng = parseFloat(sig.LNG || sig.Longitude);
            if(!isNaN(lat)) {
                L.circleMarker([lat, lng], { radius: 6, color: sig.color, fillOpacity: 1 }).addTo(map)
                 .bindTooltip(sig.typeName + ": " + (sig.SIGNAL_NAME || sig.Signal_Name));
            }
        });

        // RTIS Path (Moti Black Line)
        Papa.parse(file, { header: true, complete: function(res) {
            let path = [];
            res.data.forEach(row => {
                let lat = parseFloat(row.LATITUDE || row.LAT), lng = parseFloat(row.LONGITUDE || row.LNG);
                if(!isNaN(lat)) path.push([lat, lng]);
            });
            if(path.length > 0) {
                L.polyline(path, { color: 'black', weight: 8, opacity: 1 }).addTo(map);
                map.fitBounds(path);
            }
            setTimeout(() => map.invalidateSize(), 400);
        }});
    }
</script>
</body>
</html>
