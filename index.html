<!DOCTYPE html>
<html>
<head>
    <title>SECR AUDIT - HIGH ACCURACY MODE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial; display: flex; height: 100vh; }
        #sidebar { width: 300px; background: #002f6c; color: white; padding: 20px; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        #map { flex-grow: 1; background: #f1f1f1; }
        .speed-tag { background: white; border: 1px solid #d32f2f; color: #d32f2f; font-size: 10px; font-weight: bold; padding: 1px 3px; border-radius: 2px; text-align: center; box-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
        select, input, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: none; font-weight: bold; }
        button { background: #28a745; color: white; cursor: pointer; font-size: 16px; border-bottom: 3px solid #1e7e34; transition: 0.2s; }
        button:hover { background: #218838; }
        #log { font-size: 11px; color: #acc6e6; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; border-left: 3px solid #28a745; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="border-bottom: 2px solid #d93025; padding-bottom: 10px; font-size: 18px;">ACCURATE AUDIT TOOL</h2>
    <label>FROM STATION</label><select id="s_from"></select>
    <label>TO STATION</label><select id="s_to"></select>
    <label>RTIS DATA (22935.csv)</label><input type="file" id="csv_file">
    <button onclick="drawMap()">GENERATE ACCURATE MAP</button>
    <div id="log">System: Ready<br>Mode: Interpolation Enabled</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let master = { stns: [], sigs: [] }, rtis = [];

    function conv(v) {
        if(!v) return null;
        let n = parseFloat(v.toString().replace(/[^0-9.]/g, ''));
        return isNaN(n) ? null : Math.floor(n/100) + ((n%100)/60);
    }

    function getVal(row, keys) {
        let foundKey = Object.keys(row).find(k => keys.some(key => k.trim().toLowerCase() === key.toLowerCase()));
        return foundKey ? row[foundKey] : null;
    }

    // HIGH ACCURACY SPEED INTERPOLATION LOGIC
    function getAccurateSpd(sLt, sLg) {
        if(rtis.length === 0) return "N/A";
        
        let searchRadius = 0.002; // Approx 200m range for signal-GPS sync
        let pointsInRange = rtis.filter(p => {
            let d = Math.sqrt(Math.pow(p.lt-sLt, 2) + Math.pow(p.lg-sLg, 2));
            return d < searchRadius;
        });

        if(pointsInRange.length > 0) {
            // Sort points by proximity to signal
            pointsInRange.sort((a, b) => {
                let dA = Math.sqrt(Math.pow(a.lt-sLt, 2) + Math.pow(a.lg-sLg, 2));
                let dB = Math.sqrt(Math.pow(b.lt-sLt, 2) + Math.pow(b.lg-sLg, 2));
                return dA - dB;
            });

            // INTERPOLATION: Take average of 2 closest points if available
            let speed;
            if(pointsInRange.length >= 2) {
                speed = (pointsInRange[0].spd + pointsInRange[1].spd) / 2;
            } else {
                speed = pointsInRange[0].spd;
            }
            return speed.toFixed(1);
        }
        return "N/A";
    }

    window.onload = function() {
        const t = Date.now();
        Papa.parse("master/station.csv?v="+t, {download:true, header:true, skipEmptyLines:true, complete: r => {
            master.stns = r.data;
            let h = r.data.map(s => {
                let name = getVal(s, ['Station_Name', 'STATION']);
                return name ? `<option value="${name}">${name}</option>` : '';
            }).sort().join('');
            document.getElementById('s_from').innerHTML = h; document.getElementById('s_to').innerHTML = h;
        }});

        const files = [
            {f:'up_signals.csv', c:'green', t:'UP'}, {f:'dn_signals.csv', c:'blue', t:'DN'},
            {f:'up_mid_signals.csv', c:'purple', t:'UP-M'}, {f:'dn_mid_signals.csv', c:'red', t:'DN-M'}
        ];
        files.forEach(cfg => {
            Papa.parse("master/"+cfg.f+"?v="+t, {download:true, header:true, skipEmptyLines:true, complete: r => {
                r.data.forEach(s => { s.clr = cfg.c; s.type = cfg.t; master.sigs.push(s); });
            }});
        });
    };

    function drawMap() {
        const file = document.getElementById('csv_file').files[0];
        if(!file) return alert("Select RTIS File!");

        const map = L.map('map').setView([21.15, 79.12], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        Papa.parse(file, {header:true, skipEmptyLines:true, complete: function(res) {
            rtis = []; let path = [];
            
            let stnF = master.stns.find(s => getVal(s, ['Station_Name']) === document.getElementById('s_from').value);
            let stnT = master.stns.find(s => getVal(s, ['Station_Name']) === document.getElementById('s_to').value);
            let isDN = (conv(getVal(stnT, ['Start_Lng', 'Lng'])) > conv(getVal(stnF, ['Start_Lng', 'Lng'])));
            let activeDir = isDN ? "DN" : "UP";

            res.data.forEach(row => {
                let lt = parseFloat(getVal(row, ['Latitude', 'Lat'])), lg = parseFloat(getVal(row, ['Longitude', 'Lng']));
                if(!isNaN(lt)) {
                    rtis.push({lt, lg, spd: parseFloat(getVal(row, ['Speed', 'Spd']))});
                    path.push([lt, lg]);
                }
            });

            // 1. Journey Path
            L.polyline(path, {color: '#333', weight: 4, opacity: 0.7}).addTo(map);

            // 2. Accurate Signal Mapping
            let count = 0;
            master.sigs.forEach(sig => {
                let sLt = conv(getVal(sig, ['Lat'])), sLg = conv(getVal(sig, ['Lng']));
                if(sLt && sig.type.includes(activeDir)) {
                    let spd = getAccurateSpd(sLt, sLg);
                    
                    L.circleMarker([sLt, sLg], {radius: 7, color: sig.clr, fillOpacity: 1, weight: 2}).addTo(map)
                     .bindTooltip(`<b>${getVal(sig, ['SIGNAL_NAME'])}</b><br>Interpolated Speed: ${spd} Kmph`);
                    
                    if(spd !== "N/A") {
                        L.marker([sLt - 0.0004, sLg], {
                            icon: L.divIcon({className:'speed-tag', html: Math.round(spd), iconSize:[26,14]})
                        }).addTo(map);
                    }
                    count++;
                }
            });

            if(path.length > 0) map.fitBounds(path);
            document.getElementById('log').innerHTML = `âœ… Audit Complete!<br>Dir: ${activeDir}<br>Signals: ${count}<br>Method: Interpolated Mean`;
        }});
    }
</script>
</body>
</html>
