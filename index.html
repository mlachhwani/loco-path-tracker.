<!DOCTYPE html>
<html>
<head>
    <title>Mukesh Favorite - Final Audit</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f7f9; display: flex; flex-direction: column; height: 100vh; }
        header { background: #002f6c; color: white; padding: 12px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-items: end; }
        .box { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 10px; font-weight: bold; color: #adcce9; }
        input, select { padding: 8px; border-radius: 4px; border: none; font-size: 12px; }
        .res-name { font-size: 11px; color: #ffd700; font-weight: bold; min-height: 15px; }
        main { display: flex; flex-direction: column; flex: 1; padding: 10px; gap: 10px; overflow: hidden; }
        #map { flex: 1.5; background: white; border-radius: 8px; border: 1px solid #ccc; }
        .charts { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h4 { margin: 0 0 5px 0; font-size: 12px; color: #002f6c; }
    </style>
</head>
<body>
<header>
    <div class="box"><label>CREW ID 1 (LP/ALP/CLI)</label><input type="text" id="id1" oninput="look('1')"><div id="n1" class="res-name">-</div></div>
    <div class="box"><label>CREW ID 2 (LP/ALP/CLI)</label><input type="text" id="id2" oninput="look('2')"><div id="n2" class="res-name">-</div></div>
    <div class="box"><label>SECTION</label><div style="display:flex;gap:2px;"><select id="fStn" style="width:50%"></select><select id="tStn" style="width:50%"></select></div></div>
    <div class="box"><label>RTIS CSV</label><input type="file" id="rtis"></div>
    <button style="background:#28a745;color:white;border:none;border-radius:4px;font-weight:bold;cursor:pointer;height:34px;" onclick="audit()">GENERATE REPORT</button>
</header>
<main>
    <div id="map"></div>
    <div class="charts">
        <div class="card"><h4>Journey Speed</h4><canvas id="cJ"></canvas></div>
        <div class="card"><h4>Braking Audit</h4><canvas id="cB"></canvas></div>
    </div>
</main>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.14, 79.08], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let masters = { crew:[], pts:[] }, active = {};

    window.onload = () => {
        Papa.parse("master/crew_master.csv", { download:true, header:true, complete: r => masters.crew = r.data });
        ["master/station.csv", "master/up_signals.csv", "master/dn_signals.csv", "master/up_mid_signals.csv", "master/dn_mid_signals.csv"].forEach(f => {
            Papa.parse(f, { download:true, header:true, complete: r => r.data.forEach(s => {
                let lat = parseFloat(s.Lat || s.LAT), lng = parseFloat(s.Lng || s.LNG), name = s.Station_Name || s.Signal_Name || s.STATION;
                if(lat && lng) {
                    L.circleMarker([lat, lng], {radius:f.includes('station')?5:3, color:f.includes('station')?'orange':'blue'}).addTo(map).bindTooltip(name);
                    masters.pts.push({lat, lng, name});
                    if(f.includes('station')) {
                        document.getElementById('fStn').add(new Option(name, name));
                        document.getElementById('tStn').add(new Option(name, name));
                    }
                }
            })});
        });
    };

    function look(num) {
        let val = document.getElementById('id'+num).value.toUpperCase();
        let f = masters.crew.find(x => (x.CREW_ID || x.CLI_ID) === val);
        document.getElementById('n'+num).innerText = f ? (f.CREW_NAME || f.CLI_NAME) + " [" + (f.DESIGNATION || 'CREW') + "]" : "-";
    }

    function audit() {
        let file = document.getElementById('rtis').files[0];
        if(!file) return;
        Papa.parse(file, { header:true, dynamicTyping:true, complete: r => {
            let d = r.data.filter(x => (x.Latitude || x.lat) && x.Speed != null);
            let path = d.map(x => [x.Latitude || x.lat, x.Longitude || x.lng]);
            L.polyline(path, {color:'red', weight:3}).addTo(map); map.fitBounds(path);
            draw('cJ', d.map(x=>x.Speed), '#1a73e8');
            let stop = d.length - 1;
            for(let i=d.length-1; i>=0; i--) { if(d[i].Speed > 3) { stop = i; break; } }
            draw('cB', d.slice(Math.max(0, stop-300), stop+10).map(x=>x.Speed), '#d93025');
        }});
    }

    function draw(id, vals, clr) {
        if(active[id]) active[id].destroy();
        active[id] = new Chart(document.getElementById(id), {
            type:'line', data:{ labels:vals.map((_,i)=>i), datasets:[{data:vals, borderColor:clr, pointRadius:0, fill:false}] },
            options:{ responsive:true, maintainAspectRatio:false, scales:{x:{display:false}} }
        });
    }
</script>
</body>
</html>
