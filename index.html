<!DOCTYPE html>
<html>
<head>
    <title>Locomotive Path Tracker - Mukesh Favorite</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        
        .floating-panel {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .top-controls { top: 10px; left: 50px; display: flex; gap: 10px; }
        .info-panel { top: 10px; right: 10px; width: 220px; }
        .upload-panel { bottom: 30px; left: 20px; border: 2px dashed #457b9d; }

        .master-list-btn { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; cursor: pointer; }
        
        #speed-display { font-size: 32px; font-weight: bold; color: #e63946; margin: 5px 0; }
        .data-row { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .value { font-size: 14px; font-weight: 600; color: #1d3557; }

        input[type="file"] { font-size: 12px; margin-top: 10px; }
        .upload-title { font-size: 13px; font-weight: bold; color: #457b9d; }
    </style>
</head>
<body>

<div class="floating-panel top-controls">
    <select id="crew1" class="master-list-btn">
        <option>Select Crew (LP)</option>
        <option>Mukesh (LP)</option>
        <option>Rajesh (LP)</option>
        <option>Sanjay (LP)</option>
    </select>
    <select id="crew2" class="master-list-btn">
        <option>Select Crew (ALP)</option>
        <option>Suresh (ALP)</option>
        <option>Amit (ALP)</option>
        <option>Vikram (ALP)</option>
    </select>
</div>

<div class="floating-panel info-panel">
    <div class="data-row">
        <div class="label">Current Speed</div>
        <div id="speed-display">0.0 km/h</div>
    </div>
    <div class="data-row">
        <div class="label">Logging Time</div>
        <div id="time-val" class="value">-</div>
    </div>
    <div class="data-row">
        <div class="label">GPS Distance</div>
        <div id="dist-val" class="value">0.00 m</div>
    </div>
    <div class="data-row">
        <div class="label">Last/Cur Station</div>
        <div id="stn-val" class="value">-</div>
    </div>
    <div style="font-size: 10px; color: #999; font-style: italic;">
        Move pointer over the path to see details
    </div>
</div>

<div class="floating-panel upload-panel">
    <div class="upload-title">TRACK NEW LOCOMOTIVE</div>
    <input type="file" id="csvFile" accept=".csv" />
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let mapData = [];
    let pathLayer, startMarker, endMarker;
    
    // Initialize Map centered on India
    const map = L.map('map').setView([21.0, 78.0], 5);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Red pointer marker that follows mouse
    const hoverMarker = L.circleMarker([0, 0], {
        radius: 8, color: 'white', weight: 2, fillColor: '#e63946', fillOpacity: 1
    }).addTo(map);

    function updateMap(data) {
        // Clear existing layers
        if (pathLayer) map.removeLayer(pathLayer);
        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);

        const latlngs = data.map(p => [p.lat, p.lng]);
        
        // Draw the path
        pathLayer = L.polyline(latlngs, { 
            color: '#1d3557', 
            weight: 6, 
            opacity: 0.9,
            smoothFactor: 1
        }).addTo(map);
        
        // Add Start/End flags
        startMarker = L.marker(latlngs[0]).addTo(map).bindPopup("Journey Start");
        endMarker = L.marker(latlngs[latlngs.length - 1]).addTo(map).bindPopup("Journey End");

        // Zoom to the path
        map.fitBounds(pathLayer.getBounds(), { padding: [50, 50] });
        mapData = data;
    }

    // Interactive Hover Logic
    map.on('mousemove', function(e) {
        if (!mapData.length) return;
        
        let minDist = Infinity;
        let closest = mapData[0];
        
        // Find closest recorded point to mouse position
        for (let i = 0; i < mapData.length; i++) {
            const d = map.distance(e.latlng, [mapData[i].lat, mapData[i].lng]);
            if (d < minDist) {
                minDist = d;
                closest = mapData[i];
            }
        }

        // Update UI elements
        hoverMarker.setLatLng([closest.lat, closest.lng]);
        document.getElementById('speed-display').innerText = closest.s + ' km/h';
        document.getElementById('time-val').innerText = closest.t;
        document.getElementById('dist-val').innerText = closest.d + ' m';
        document.getElementById('stn-val').innerText = closest.st;
    });

    // Handle CSV Uploads
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                const newData = results.data
                    .filter(row => (row.Latitude || row.LATITUDE) && (row.Longitude || row.LONGITUDE))
                    .map(row => ({
                        t: row['Logging Time'] || row['TIME'] || row['Time'] || '',
                        lat: row['Latitude'] || row['LATITUDE'],
                        lng: row['Longitude'] || row['LONGITUDE'],
                        s: row['Speed'] || row['SPEED'] || 0,
                        d: row['distFromPrevLatLng'] || row['Distance'] || 0,
                        st: row['last/cur stationCode'] || row['STATION'] || ''
                    }));
                
                if (newData.length > 0) {
                    updateMap(newData);
                } else {
                    alert("Format Error: Ensure CSV has Latitude and Longitude columns.");
                }
            }
        });
    });
</script>
</body>
</html>
