<!DOCTYPE html>
<html>
<head>
    <title>Sanket 2.0 - Advanced Crew Audit</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --rail-blue: #1a73e8; --rail-red: #d93025; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        #sidebar { width: 350px; background: #f8f9fa; border-right: 1px solid #ddd; padding: 15px; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #map-container { flex-grow: 1; position: relative; }
        #map { height: 70%; width: 100%; }
        #analysis-section { height: 30%; background: white; border-top: 2px solid #ddd; padding: 10px; overflow-y: auto; }
        
        .form-group { margin-bottom: 12px; }
        label { font-size: 12px; font-weight: bold; color: #555; display: block; }
        select, input { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-audit { width: 100%; background: var(--rail-blue); color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        .violation-blink { animation: blinker 1s linear infinite; color: red; font-weight: bold; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .report-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .bg-red { background-color: #ffd7d4 !important; color: #d93025; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>Audit Dashboard</h3>
    <div class="form-group">
        <label>CLI Analysis By</label>
        <select id="cliSelect"><option>Loading Master...</option></select>
    </div>
    <hr>
    <div class="form-group">
        <label>LP Selection</label>
        <select id="lpSelect" onchange="updateCrewDetails('lp')"><option>Select LP</option></select>
        <div id="lpInfo" style="font-size:11px; color:#666;"></div>
    </div>
    <div class="form-group">
        <label>Loco & Train No.</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="locoNo" placeholder="Loco">
            <input type="text" id="trainNo" placeholder="Train">
        </div>
    </div>
    <div class="form-group">
        <label>Stock Type & MPS</label>
        <div style="display:flex; gap:5px;">
            <select id="stockType">
                <option value="COACHING">Coaching</option>
                <option value="VB">Vande Bharat</option>
                <option value="GOODS">Goods</option>
                <option value="LE">Light Engine</option>
            </select>
            <select id="mpsLimit">
                <option value="110">110 Kmph</option>
                <option value="130">130 Kmph</option>
                <option value="140">140 Kmph</option>
                <option value="75">75 Kmph</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label>Departure Time</label>
        <input type="datetime-local" id="depTime">
    </div>
    <div class="form-group">
        <label>Arrival Time</label>
        <input type="datetime-local" id="arrTime">
    </div>
    <div class="form-group">
        <label>Upload Loco Data (.csv)</label>
        <input type="file" id="locoFile" accept=".csv">
    </div>
    <button class="btn-audit" onclick="runAnalysis()">GENERATE ADVANCED REPORT</button>
</div>

<div id="map-container">
    <div id="map"></div>
    <div id="analysis-section">
        <div id="reportTitle" style="font-weight:bold; margin-bottom:10px;">Analysis Results</div>
        <canvas id="brakingChart" style="max-height: 150px;"></canvas>
        <div id="auditResults"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.23, 79.28], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let masterData = { cli: [], crew: [] };
    
    // Load Master Files
    function loadMaster() {
        Papa.parse("master/cli_master.csv", { download: true, header: true, complete: r => {
            const select = document.getElementById('cliSelect');
            select.innerHTML = r.data.map(c => `<option value="${c.CLI_ID}">${c.CLI_NAME}</option>`).join('');
        }});
        Papa.parse("master/crew_master.csv", { download: true, header: true, complete: r => {
            masterData.crew = r.data;
            const select = document.getElementById('lpSelect');
            select.innerHTML += r.data.map(c => `<option value="${c.CREW_ID}">${c.CREW_NAME}</option>`).join('');
        }});
    }

    function updateCrewDetails(type) {
        const id = document.getElementById('lpSelect').value;
        const crew = masterData.crew.find(c => c.CREW_ID === id);
        if(crew) document.getElementById('lpInfo').innerHTML = `Desig: ${crew.DESIGNATION} | CLI: ${crew.G_CLI}`;
    }

    function runAnalysis() {
        const stock = document.getElementById('stockType').value;
        const mps = parseInt(document.getElementById('mpsLimit').value);
        // Braking Logic Implementation
        // Hum yahan loco data ko filter karenge aur 2000m/1000m speed violation check karenge
        alert("Analyzing " + stock + " braking pattern at MPS " + mps + "...");
        // Detail report generation logic starts here...
    }

    loadMaster();
</script>
</body>
</html>
