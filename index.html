<!DOCTYPE html>
<html>
<head>
    <title>Sanket 2.0 - Advanced Crew Audit System</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --rail-blue: #1a73e8; --rail-red: #d93025; --rail-green: #1e8e3e; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; background: #eee; }
        
        /* Sidebar Styles */
        #sidebar { width: 380px; background: white; border-right: 1px solid #ccc; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 2000; }
        h3 { color: var(--rail-blue); border-bottom: 2px solid var(--rail-blue); padding-bottom: 10px; margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        label { font-size: 12px; font-weight: bold; color: #444; display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; box-sizing: border-box; }
        .btn-run { width: 100%; background: var(--rail-blue); color: white; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 10px; }
        .btn-run:hover { background: #1557b0; }

        /* Main Content */
        #main { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        #map { flex-grow: 1; width: 100%; }
        #analysis-panel { height: 300px; background: white; border-top: 3px solid #ccc; padding: 15px; overflow-y: auto; display: none; }
        
        /* Analysis UI */
        .violation-row { background: #fce8e6 !important; color: #c5221f; font-weight: bold; }
        .blink-path { animation: blinker 0.8s linear infinite; stroke: red; stroke-width: 8; }
        @keyframes blinker { 50% { opacity: 0.2; } }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th { background: #f1f3f4; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .chart-container { height: 180px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>Audit Dashboard</h3>
    
    <div class="form-group">
        <label>CLI Analysis By</label>
        <select id="cliSelect"><option>Loading CLI Master...</option></select>
    </div>

    <div class="form-group">
        <label>Crew Details (LP / ALP)</label>
        <select id="lpSelect" onchange="updateCrewInfo()"><option value="">Select LP</option></select>
        <div id="lpDetail" style="font-size:11px; color:#1a73e8; margin-top:5px; font-weight:bold;"></div>
    </div>

    <div class="form-group" style="display:flex; gap:10px;">
        <div style="flex:1"><label>Loco No.</label><input type="text" id="locoNo" placeholder="e.g. 30385"></div>
        <div style="flex:1"><label>Train No.</label><input type="text" id="trainNo" placeholder="e.g. 58205"></div>
    </div>

    <div class="form-group">
        <label>Type of Stock</label>
        <select id="stockType">
            <option value="COACHING">Coaching (Standard)</option>
            <option value="VB">Vande Bharat</option>
            <option value="GOODS">Goods</option>
            <option value="LE">Light Engine</option>
        </select>
    </div>

    <div class="form-group">
        <label>Select MPS (kmph)</label>
        <select id="mpsLimit">
            <script>
                for(let i=40; i<=140; i+=5) document.write(`<option value="${i}">${i} kmph</option>`);
                document.getElementById('mpsLimit').value = "110";
            </script>
        </select>
    </div>

    <div class="form-group">
        <label>Departure (Start)</label>
        <input type="datetime-local" id="depTime">
    </div>

    <div class="form-group">
        <label>Arrival (End)</label>
        <input type="datetime-local" id="arrTime">
    </div>

    <div class="form-group">
        <label>Upload Loco GPS (.csv)</label>
        <input type="file" id="locoFile" accept=".csv">
    </div>

    <button class="btn-run" onclick="processAudit()">GENERATE AUDIT REPORT</button>
</div>

<div id="main">
    <div id="map"></div>
    <div id="analysis-panel">
        <h4 id="reportTitle">Braking Tech & MPS Analysis</h4>
        <div class="chart-container">
            <canvas id="brakingChart"></canvas>
        </div>
        <div id="auditTableContainer"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.23, 79.28], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let masterCrew = [];
    let locoData = [];
    let brakingChart = null;

    // Load Masters
    window.onload = () => {
        Papa.parse("master/cli_master.csv", { download: true, header: true, complete: r => {
            const s = document.getElementById('cliSelect');
            s.innerHTML = r.data.map(c => `<option>${c.CLI_NAME} (${c.CLI_ID})</option>`).join('');
        }});
        Papa.parse("master/crew_master.csv", { download: true, header: true, complete: r => {
            masterCrew = r.data;
            const s = document.getElementById('lpSelect');
            s.innerHTML += r.data.map(c => `<option value="${c.CREW_ID}">${c.CREW_NAME}</option>`).join('');
        }});
        // Load Stations/Signals automatically
        loadMarkers('station.csv', 'station');
        loadMarkers('dn_signals.csv', 'DN');
        loadMarkers('up_signals.csv', 'UP');
    };

    function updateCrewInfo() {
        const id = document.getElementById('lpSelect').value;
        const c = masterCrew.find(x => x.CREW_ID === id);
        if(c) document.getElementById('lpDetail').innerText = `${c.DESIGNATION} | G-CLI: ${c.G_CLI}`;
    }

    function loadMarkers(file, type) {
        Papa.parse("master/" + file, { download: true, header: true, complete: r => {
            r.data.forEach(row => {
                if(row.Lat || row['Start_Lat ']) {
                    // Logic to add markers to map (simplified for brevity)
                }
            });
        }});
    }

    // MAIN AUDIT LOGIC
    function processAudit() {
        const file = document.getElementById('locoFile').files[0];
        if(!file) return alert("Pehle Loco File upload karein!");

        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                locoData = results.data.filter(d => d.Latitude);
                const stock = document.getElementById('stockType').value;
                const mps = parseInt(document.getElementById('mpsLimit').value);
                
                analyzeBraking(stock, mps);
                document.getElementById('analysis-panel').style.display = 'block';
            }
        });
    }

    function analyzeBraking(stock, mps) {
        // Logic: 1. Identify Stop Points (Speed 0)
        // 2. Look back 2000m and 1000m
        // 3. Check against rules:
        const rules = {
            'VB': { m2000: 110, m1000: 90 },
            'COACHING': { m2000: 100, m1000: 60 },
            'GOODS': { m2000: 55, m1000: 40 },
            'LE': { m2000: 90, m1000: 60 }
        };

        const rule = rules[stock];
        let reportHtml = `<table><tr><th>Event</th><th>Speed @2000m</th><th>Speed @1000m</th><th>Status</th></tr>`;
        
        // Find stops and check violation
        // (Pseudocode logic for finding stops and calculating distance-based speed)
        
        reportHtml += `<tr class="violation-row"><td>Stop at DURG</td><td>105 kmph</td><td>75 kmph</td><td>⚠️ VIOLATION</td></tr>`;
        reportHtml += `</table>`;
        document.getElementById('auditTableContainer').innerHTML = reportHtml;

        // Generate Chart
        const ctx = document.getElementById('brakingChart').getContext('2d');
        if(brakingChart) brakingChart.destroy();
        brakingChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['2000m', '1500m', '1000m', '500m', 'Stop'],
                datasets: [{
                    label: 'Actual Speed (kmph)',
                    data: [105, 90, 75, 40, 0],
                    borderColor: 'red',
                    fill: false
                }, {
                    label: 'Target (Smooth)',
                    data: [rule.m2000, 80, rule.m1000, 30, 0],
                    borderColor: 'green',
                    borderDash: [5, 5],
                    fill: false
                }]
            }
        });
    }
</script>
</body>
</html>
