<!DOCTYPE html>
<html>
<head>
    <title>Sanket 5.0 - Master Integrated Audit</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: #002f6c; color: white; padding: 10px 20px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-items: end; }
        .box { display: flex; flex-direction: column; gap: 2px; }
        label { font-size: 10px; font-weight: bold; color: #adcce9; }
        input, select { padding: 6px; border-radius: 4px; border: none; font-size: 12px; }
        .name-tag { font-size: 11px; color: #ffd700; font-weight: bold; min-height: 14px; }
        
        main { display: grid; grid-template-rows: 1.2fr 1fr; gap: 10px; padding: 10px; flex: 1; overflow: hidden; }
        #map { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: white; padding: 10px; border-radius: 8px; position: relative; }
        h4 { margin: 0 0 5px 0; font-size: 12px; color: #002f6c; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<header>
    <div class="box"><label>CLI ID</label><input type="text" id="cliId" oninput="look('cli')"><div id="cliN" class="name-tag">-</div></div>
    <div class="box"><label>LP ID</label><input type="text" id="lpId" oninput="look('lp')"><div id="lpN" class="name-tag">-</div></div>
    <div class="box"><label>Section</label><div style="display:flex;gap:2px;"><select id="fStn" style="width:50%"></select><select id="tStn" style="width:50%"></select></div></div>
    <div class="box"><label>RTIS Loco CSV</label><input type="file" id="locoFile"></div>
    <button style="background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;height:30px;" onclick="runAudit()">GENERATE REPORT</button>
</header>

<main>
    <div id="map"></div>
    <div class="charts">
        <div class="card"><h4>Journey Profile</h4><canvas id="chartJ"></canvas></div>
        <div class="card"><h4>Braking Technique (Final Approach)</h4><canvas id="chartB"></canvas></div>
    </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.14, 79.08], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let masters = { crew:[], stn:[] };
    let activeCharts = {};

    // Helper: Convert DDMM.MMMM to Decimal Degrees
    function toDD(val) {
        if (!val) return null;
        let s = val.toString();
        let deg = parseFloat(s.substring(0, s.indexOf('.') - 2));
        let min = parseFloat(s.substring(s.indexOf('.') - 2));
        return deg + (min / 60);
    }

    // Load All 5 Master Files Automatically
    window.onload = () => {
        Papa.parse("master/crew_master.csv", { download:true, header:true, complete: r => masters.crew = r.data });
        
        const signalFiles = ["master/station.csv", "master/up_signals.csv", "master/dn_signals.csv", "master/up_mid_signals.csv", "master/dn_mid_signals.csv"];
        signalFiles.forEach(file => {
            Papa.parse(file, { download:true, header:true, complete: r => {
                r.data.forEach(s => {
                    let lat = toDD(s.Lat || s.LAT || s.Latitude);
                    let lng = toDD(s.Lng || s.LNG || s.Longitude);
                    if(lat && lng) {
                        let color = file.includes('station') ? 'orange' : 'blue';
                        L.circleMarker([lat, lng], {radius:4, color: color}).addTo(map).bindTooltip(s.Station_Name || s.Signal_Name || "Point");
                        if(file.includes('station')) {
                            document.getElementById('fStn').add(new Option(s.Station_Name, s.Station_Name));
                            document.getElementById('tStn').add(new Option(s.Station_Name, s.Station_Name));
                        }
                    }
                });
            }});
        });
    };

    function look(t) {
        let id = document.getElementById(t+'Id').value.toUpperCase();
        let f = masters.crew.find(x => (x.CREW_ID || x.CLI_ID) === id);
        document.getElementById(t+'N').innerText = f ? (f.CREW_NAME || f.CLI_NAME) : "-";
    }

    function runAudit() {
        let file = document.getElementById('locoFile').files[0];
        if(!file) return;
        Papa.parse(file, { header:true, dynamicTyping:true, complete: r => {
            let data = r.data.filter(x => (x.Latitude || x.lat) && x.Speed != null);
            
            // Draw Path
            let path = data.map(x => [x.Latitude || x.lat, x.Longitude || x.lng]);
            L.polyline(path, {color:'red', weight:3}).addTo(map);
            map.fitBounds(path);

            // Chart 1: Full Speed
            draw('chartJ', data.map(x=>x.Speed), 'Blue', 'KMPH');

            // Chart 2: BRAKING FIX (Takes last 300 points to show the curve, not just 0)
            let bPoints = data.slice(-300);
            draw('chartB', bPoints.map(x=>x.Speed), 'Red', 'Braking Curve');
        }});
    }

    function draw(id, vals, clr, lbl) {
        if(activeCharts[id]) activeCharts[id].destroy();
        activeCharts[id] = new Chart(document.getElementById(id), {
            type: 'line',
            data: { labels: vals.map((_,i)=>i), datasets:[{label:lbl, data:vals, borderColor:clr, pointRadius:0}] },
            options: { responsive:true, maintainAspectRatio:false, scales:{x:{display:false}} }
        });
    }
</script>
</body>
</html>
