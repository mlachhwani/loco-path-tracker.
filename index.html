<!DOCTYPE html>
<html>
<head>
    <title>Sanket 2.0 - Professional Audit Pro</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --rail-blue: #002f6c; --rail-active: #1a73e8; --violation: #d93025; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #f8f9fa; }
        
        /* Top Navigation Bar */
        #top-bar { background: var(--rail-blue); color: white; padding: 10px 20px; display: grid; grid-template-columns: repeat(5, 1fr) auto; gap: 15px; align-items: end; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 2000; }
        .input-box { display: flex; flex-direction: column; gap: 4px; }
        .input-box label { font-size: 10px; font-weight: bold; color: #adcce9; text-transform: uppercase; }
        input, select { padding: 6px; border-radius: 4px; border: none; font-size: 12px; }
        .disp-text { font-size: 11px; color: #fff; font-weight: bold; margin-top: 2px; height: 14px; }
        .btn-generate { background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Map & Graph Layout */
        #map { flex: 1; min-height: 45vh; width: 100%; border-bottom: 3px solid #ccc; }
        #graph-container { height: 35vh; background: white; padding: 10px; position: relative; }
        
        /* Floating Speedo on Map */
        #map-overlay { position: absolute; top: 80px; left: 20px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; border-left: 5px solid var(--rail-active); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); pointer-events: none; }
        
        .blink-violation { animation: blinker 0.8s linear infinite; stroke: red; stroke-width: 8; }
        @keyframes blinker { 50% { opacity: 0.1; } }
    </style>
</head>
<body>

<div id="top-bar">
    <div class="input-box">
        <label>CLI Details</label>
        <input type="text" id="cliId" placeholder="CLI ID" oninput="lookupCLI()">
        <div id="cliName" class="disp-text">-</div>
    </div>
    <div class="input-box">
        <label>LP / ALP ID</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="lpId" placeholder="LP ID" oninput="lookupCrew('lp')">
            <input type="text" id="alpId" placeholder="ALP ID" oninput="lookupCrew('alp')">
        </div>
        <div id="crewName" class="disp-text">-</div>
    </div>
    <div class="input-box">
        <label>Loco / Train / Stock</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="locoNo" placeholder="Loco" style="width:50px;">
            <select id="stockType" style="width:90px;">
                <option value="COACHING">Coaching</option>
                <option value="VB">VB</option>
                <option value="GOODS">Goods</option>
                <option value="LE">LE</option>
            </select>
            <select id="mpsLimit" id="mpsLimit"></select>
        </div>
        <div id="stockInfo" class="disp-text">Select Params</div>
    </div>
    <div class="input-box">
        <label>Section (From - To)</label>
        <div style="display:flex; gap:5px;">
            <select id="fromStn"><option value="">From</option></select>
            <select id="toStn"><option value="">To</option></select>
        </div>
    </div>
    <div class="input-box">
        <label>Loco GPS File</label>
        <input type="file" id="locoFile">
    </div>
    <button class="btn-generate" onclick="startFullAudit()">GENERATE REPORT</button>
</div>

<div id="map-overlay">
    <div style="font-size:10px; color:#666;">LIVE TRACKER</div>
    <div id="live-speed" style="font-size:24px; font-weight:bold; color:var(--violation);">0 kmph</div>
    <div id="live-stn" style="font-size:12px; font-weight:bold;">No Data Loaded</div>
</div>

<div id="map"></div>

<div id="graph-container">
    <canvas id="mainChart"></canvas>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([21.23, 79.28], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let masters = { cli:[], crew:[], stn:[] };
    let fullLocoData = [];
    let chartInstance = null;

    // Load Masters & Setup UI
    window.onload = () => {
        const mps = document.getElementById('mpsLimit');
        for(let i=40; i<=140; i+=5) mps.add(new Option(i+"K", i));
        mps.value = 110;

        Papa.parse("master/cli_master.csv", { download: true, header: true, complete: r => masters.cli = r.data });
        Papa.parse("master/crew_master.csv", { download: true, header: true, complete: r => masters.crew = r.data });
        Papa.parse("master/station.csv", { download: true, header: true, complete: r => {
            masters.stn = r.data;
            r.data.forEach(s => {
                document.getElementById('fromStn').add(new Option(s.Station_Name, s.Station_Name));
                document.getElementById('toStn').add(new Option(s.Station_Name, s.Station_Name));
            });
        }});
    };

    function lookupCLI() {
        const f = masters.cli.find(x => x.CLI_ID === document.getElementById('cliId').value.toUpperCase());
        document.getElementById('cliName').innerText = f ? f.CLI_NAME : "-";
    }

    function lookupCrew(type) {
        const f = masters.crew.find(x => x.CREW_ID === document.getElementById(type+'Id').value.toUpperCase());
        if(f) document.getElementById('crewName').innerText = f.CREW_NAME + " (" + f.DESIGNATION + ")";
    }

    function startFullAudit() {
        const file = document.getElementById('locoFile').files[0];
        if(!file) return alert("Upload CSV!");
        
        Papa.parse(file, {
            header: true, dynamicTyping: true, complete: r => {
                fullLocoData = r.data.filter(d => d.Latitude).map(d => ({
                    lat: d.Latitude, lng: d.Longitude, speed: d.Speed, stn: d['last/cur stationCode'] || 'Section'
                }));
                drawAuditUI();
            }
        });
    }

    function drawAuditUI() {
        // 1. Draw Map Path
        const pathCoords = fullLocoData.map(p => [p.lat, p.lng]);
        L.polyline(pathCoords, {color: '#1a73e8', weight: 4}).addTo(map);
        map.fitBounds(pathCoords);

        // 2. Interactive Pointer on Map
        let pointer = L.circleMarker([0,0], {radius: 7, color: 'white', fillColor: 'red', fillOpacity: 1}).addTo(map);
        map.on('mousemove', e => {
            let close = fullLocoData.reduce((prev, curr) => 
                map.distance(e.latlng, [curr.lat, curr.lng]) < map.distance(e.latlng, [prev.lat, prev.lng]) ? curr : prev);
            pointer.setLatLng([close.lat, close.lng]);
            document.getElementById('live-speed').innerText = close.speed + " kmph";
            document.getElementById('live-stn').innerText = close.stn;
        });

        // 3. Generate Single Continuous Graph
        renderProfessionalGraph();
    }

    function renderProfessionalGraph() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        const speeds = fullLocoData.map(p => p.speed);
        const labels = fullLocoData.map((p, i) => i); // Sequential points

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Actual Speed',
                    data: speeds,
                    borderColor: '#1a73e8',
                    borderWidth: 2,
                    pointRadius: 0,
                    segment: {
                        borderColor: ctx => ctx.p1.raw > 110 ? 'red' : undefined // Basic overspeed highlight
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#e0e0e0' },
                        title: { display: true, text: 'Speed (kmph)' }
                    },
                    x: { display: false }
                },
                plugins: {
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }
</script>
</body>
</html>
